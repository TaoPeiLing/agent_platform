# API密钥管理指南

## 1. 概述

本文档为企业级智能代理平台的集成系统提供API密钥管理的最佳实践和安全指导。API密钥是集成系统访问平台API的主要认证方式，正确管理API密钥对于确保系统安全和可靠至关重要。

## 2. API密钥基础知识

### 2.1 什么是API密钥

API密钥是一个唯一的标识符，用于验证对API的访问请求。在我们的平台中，API密钥由以下部分组成：

- **密钥前缀**：一个短的、可公开的标识符（通常为8个字符）
- **密钥主体**：一个长的、保密的随机字符串
- **服务账户ID**：每个API密钥关联到特定的服务账户

### 2.2 API密钥与其他认证方式比较

| 认证方式 | 主要用途 | 优势 | 劣势 |
|---------|---------|------|------|
| API密钥 | 系统间集成 | 简单、易于实现 | 泄露风险，缺乏精细控制 |
| JWT令牌 | 服务间通信 | 包含更多信息，可设置短期过期 | 配置复杂 |
| 客户端证书 | 高安全要求场景 | 双向认证，高安全性 | 配置和管理复杂 |

## 3. API密钥生命周期管理

### 3.1 密钥创建

API密钥可以通过以下方式创建：

1. 通过平台管理界面
2. 使用专用的API端点：`POST /api/v1/auth/keys`

创建密钥时需要提供：
- 服务账户标识符
- 密钥描述（用途说明）
- 可选的过期时间

**注意**：新创建的API密钥只会在创建时完整展示一次。务必立即安全地存储这个密钥。

### 3.2 密钥轮换

定期轮换API密钥是安全最佳实践：

- 推荐每90天轮换一次生产环境的API密钥
- 实施轮换时，首先创建新密钥并更新客户端
- 确认新密钥正常工作后，再废弃旧密钥
- 使用重叠期，确保服务不中断

### 3.3 密钥撤销

在以下情况应立即撤销API密钥：

- 密钥泄露或疑似泄露
- 关联项目结束
- 员工离职或变更角色
- 不再需要集成

撤销密钥使用API端点：`DELETE /api/v1/auth/keys/{key_prefix}`

## 4. API密钥安全实践

### 4.1 安全存储

API密钥应当：

- 永不硬编码在应用代码中
- 永不存储在版本控制系统中
- 存储在安全的密钥管理系统中（如AWS Secrets Manager, HashiCorp Vault）
- 在应用程序中，从环境变量或密钥管理服务获取

### 4.2 传输安全

使用API密钥时确保：

- 所有API请求都通过HTTPS进行
- 优先使用请求头传递API密钥（`X-API-Key`）
- 避免在URL中传递API密钥
- 使用私有网络连接（如有可能）

### 4.3 权限最小化

每个API密钥应遵循最小权限原则：

- 仅授予完成特定任务所需的权限
- 为不同的集成目的创建不同的密钥
- 定期审核密钥权限，移除不必要的权限

### 4.4 监控和审计

实施以下监控措施：

- 监控异常的API使用模式
- 设置基于API密钥的使用告警
- 记录所有API密钥的创建、修改和撤销操作
- 定期审核API密钥清单并清理未使用的密钥

## 5. 集成最佳实践

### 5.1 认证请求格式

API密钥可以通过以下方式在请求中使用：

**HTTP头部方法（推荐）**：
```
GET /api/v1/agents HTTP/1.1
Host: api.enterprise-agent-platform.com
X-API-Key: your-api-key-here
```

**Bearer令牌方式**：
```
GET /api/v1/agents HTTP/1.1
Host: api.enterprise-agent-platform.com
Authorization: Bearer your-api-key-here
```

### 5.2 错误处理

处理API认证错误的最佳实践：

- 实现指数退避重试策略
- 区分认证错误和其他类型错误
- 当收到认证错误时，不要无限重试（可能是密钥已撤销）
- 设置监控提醒，在认证失败时及时通知

### 5.3 多环境配置

在多个环境中管理API密钥：

- 为不同环境（开发、测试、生产）使用不同的API密钥
- 在CI/CD流程中安全地处理密钥
- 在本地开发环境使用有限权限的密钥

## 6. 常见问题与解决方案

### 6.1 我的API密钥泄露了，应该怎么办？

1. 立即撤销泄露的密钥
2. 创建新的API密钥
3. 更新所有使用该密钥的应用程序
4. 检查是否有未授权的访问
5. 查明泄露原因并加强安全措施

### 6.2 如何判断哪些API密钥未被使用？

平台提供以下方式查看API密钥使用情况：

- 通过管理界面查看每个密钥的最后使用时间
- 使用API端点获取密钥使用报告：`GET /api/v1/auth/keys/usage`
- 设置自动告警，提示长期未使用的密钥

### 6.3 如何处理依赖第三方的集成？

当需要将API密钥提供给第三方服务时：

- 创建专用的、权限受限的API密钥
- 设置适当的使用限制（速率限制、IP限制）
- 实施定期轮换策略
- 建立服务水平协议(SLA)，规定第三方如何保护您的密钥

## 7. 参考资料

- [OWASP API安全Top 10](https://owasp.org/www-project-api-security/)
- [NIST密钥管理指南](https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final)
- [平台API文档](../api/reference.md)
- [安全集成示例](../examples/secure_integration.md) 